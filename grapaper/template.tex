%% Thesis Template of Nanjing University
%%   for using NJUthesis package with LaTeX2e
%%
%% Created by Wenbo Yang <http://solrex.org>
%% Homepage: http://share.solrex.org/njuthesis/
%%
%% $Id: template.tex,v 0.2 2010/05/01 Exp $

\documentclass[dvipdfm, oneside, master]{NJUthesis}
% 可选参数：
%   nobackinfo 取消封二页导师签名信息
%   oneside/twoside 单面/双面打印
%   phd/master 博士/硕士论文
% 下面三个选一个：
% dvipdfm 使用 dvipdfm(x) 生成最终的 PDF 文档 (缺省设置，不建议修改）
% dvips 使用 dvips 生成最终的 PS 文档
% pdftex 使用 pdfLaTeX 生成最终的 PDF 文档

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 导言区
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 小节标题靠左对齐
\CTEXsetup[format+={\flushleft}]{section}

% 设置链接颜色
\hypersetup{
% pdf 属性
             pdftitle={南京大学电子学院赵东威毕业论文}, %
            pdfauthor={赵东威}
}

% 表格
\usepackage{longtable, multirow}
% 英文使用 Times 字体
\usepackage{times}
% 源代码
\usepackage{fancyvrb}
% 自定义列表样式
\usepackage{enumitem}
\usepackage{tikz}
\usepackage{comment}
\usepackage{subfig}

\newenvironment{packed_enum}{
\begin{enumerate}
  \setlength{\itemsep}{1pt}
  \setlength{\parskip}{0pt}
  \setlength{\parsep}{0pt}
}{\end{enumerate}}

\begin{document}
\newcommand{\axises}[4]{%
    \draw[very thin,color=gray] (-0.2,-0.2) grid (#3 - 0.1,#4 - 0.1);
    \draw[->, opacity=1] (-0.2,0) -- (#3,0) node[right] {#1};
    \draw[->, opacity=1] (0,-0.2) -- (0,#4) node[above] {#2};
    \draw [opacity=1] (0,0) node[below left] {$o$};
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 封面部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% 国家图书馆封面内容字符串
% 仅博士需要填写并保证模板参数选择了 phd
\classification{}
\confidential{}
\UDC{}
\titlelinea{南京大学学位论文}
\titlelineb{~\LaTeX{}~模板}
\titlelinec{}
\advisorinfo{南京大学~数学系}
\chairman{XXX 教授}
\reviewera{某某某某　副研究员}
\reviewerb{XXX 教授}
\reviewerc{XXX 教授}
\reviewerd{XXX 教授}
\nlcfootdate{2013~年~5~月~1~日}

% 南大中文封面内容字符串
\title{基于结构光的3D重建系统}
\author{赵东威}
\studentnum{~MG1023041}
\grade{2010}
\advisor{都思丹~~教授}
\major{电路与系统}
\researchfield{计算机视觉}
\footdate{2013~年~5~月}
\submitdate{2013~年~5~月~10~日}
\defenddate{2013~年~5~月~20~日}

% 英文封面内容字符串
\englishtitle{3D Reconstruction System Based on Structured Light}
\englishauthor{Dongwei Zhao}
\englishadvisor{Professor Sidan Du}
\englishinstitute{School of Electronic Engineering\\
 Nanjing University}
\englishdegree{Master}
\englishmajor{Circuit System}
\englishdate{May 2013}

% 制作封面命令
\maketitle

% 制作英文封面命令
\makeenglishtitle


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 前言部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\frontmatter

% 中文摘要
\begin{abstract}

3D信息采集是计算机视觉领域的热点问题，在医疗、文物保护以及机器人导航领域有着广泛应用，近年来也受到了越来越多的研究关注。长久以来，研究人员提出了多种方法用于3D信息采集，包括立体成像、激光雷达、3D 重建等。在这其中，
3D重建方法不需要专用设备，同时具有图像处理简单、重建结果的分辨率高等特点而受到重视。

本文实现了基于投影仪-摄像机三角测量系统的3D重建。首先通过摄像机定标和投影仪定标获得摄像机和投影仪之间的几何关系，建立了三角测量的硬件环境和几何基础。其次利用两种结构光进行3D重建，一种结构光是格雷码加相移编码方式。这种结构光编码方式属于时间编码，需要投射多幅结构光并拍摄多幅图像，故适用于静止物体的重建，其优点是能够得到高分辨率的重建结果。另一种结构光是基于De Bruijn序列编码的颜色条纹，采用这种结构光的重建只需拍摄一幅图像即可实现，重建时间短，适用于动态物体的重建，但相对于第一种方法，本方法要求的编码解码处理较为复杂，需要先进的编解码技术才能够达到理想的重建结果。本文对编解码技术的投射颜色选择、颜色校正、线条检测、峰值定位和颜色识别进行了创新，提出了有效的方法并提升了特征检测的准确率，得到了很好的重建效果。对基于格雷码加相移编码方式的陈重建中，本文提出了对格雷码光栅边境进行准确定位的方法，提升了重建的效果。

\keywords{3D重建; 结构光; 编码; 三角测量}

\end{abstract}

% 英文摘要
\begin{englishabstract}

In the last decade, 3D shape acquisition has received more and more considerable research interests. Since the moment when the concept of 3D reconstruction was proposed, researchers have developed some groups of techniques
to achieve 3D shape acquisition, some important methods include  and structured light\cite{sansoni2009state}, stereo vision and TOF(Time Of Flight).
Among those methods, one of the main advantages of structured light
based techniques is that it requires less and easier image processing, meanwhile, it can derive high accuracy in the 3D reconstruction result\cite{OptimisedDeBruijn}.
 Based on the math of triangle principle, structured light based techniques take three steps to fulfill final result. The first step is to project some designed coding patterns onto the surface of the scanned
objects. After that, a camera (or more) is controlled to capture the scene and send the pictures to computer for further processing. In the second step, algorithms detect the coding patterns in the captured image and establish the correspondence with projected patterns. In the final step, 3D coordinates of the object surface are calculated from the correspondence established in the second step within the calibrated triangle model.

In the review of the development history of structured light techniques, the first appeared techniques are the time-multiplexing techniques, which are also called multi-shots techniques because multi patterns are projected onto the surface and multi images are taken. Actually there are both advantages and disadvantages using this method. Advantages include high accuracy and resolution and the disadvantage is that the scanning speed is slow. After that, one-shot structured light system is developed to achieve high resolution within a short time. In one-shot structured light system, there are three key processes which would effect final reconstruction result, which includes the choose of projected patterns, detection of pattern in captured image and the algorithms applied to establishment of correspondence between captured and projected patterns. Recently, more and more efforts have been made in order to generate higher quality result, which makes this method widely used in industry design and cultural heritage protection.

In this paper, we have build a structure light system and this system uses two methods: De Bruijn code based colored stripe and Gay code as structure light, which belongs to one-shot structured light technique and time-multiplexing technique. To achieve a better reconstruction result using colored stripes, we propose an adaptive color calibration method, and a Discrete Trend Transform (DTT) algorithm to detect patterns. And we proposed a method to detect the edge of Gray code structured light edge. In this system, dark laboratory environments is not needed to derive high-resolution 3D point cloud.

\englishkeywords{three-dimensional image acquisition; adaptive color calibration;
discrete trend transform; structured light.}

\end{englishabstract}

% 生成目录命令
\tableofcontents

% 以下两个目录可根据具体情况注释掉
% 生成表格目录命令
%\listoftables
% 生成插图目录命令
%\listoffigures


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 正文部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\mainmatter

\chapter{绪论}
\section{引言}
人类生活在一个由三维的空间和时间组成的四维立体空间中，我们的眼睛不仅能感知周围事物的色彩光泽，还能够通过双目立体视觉的方式感知立体空间。在科技不发达的古代和近代，人们缺少描述和记录三维时间的方式，只能通过画画、照相、电影等行为以二维的方式记录周围的世界。随着
计算机的发明和极快的普及，互联网和计算能力的快速增长深刻地影响人们的生产生活方式，其中尤以3D技术的影响最为突出。三维数字化技术使人们有能力对现实三维世界的认识和表达回归到原始的直观、立体的境界。在现代化的21世纪，3D的概念已然充斥着虚拟的世界，也在深刻影响着现实的世界。从3D游戏、动画到计算机辅助制造、3D打印、医学成像、自动驾驶汽车等，都包含着3D技术的应用。如果现在的世界不能称为3D 世界，那么可以预想的是，不久的未来3D技术的应用将会更加普及。

3D技术包含一系列的过程，包括采集、处理、识别等，而这其中3D信息的采集技术是基础，所采集的3D信息可用于进一步处理和转化进而为提供有意义的信息或为决策提供基础。可以说，3D 信息的采集技术直接影响着3D技术应用范畴。

3D重建是3D信息的采集的一个重要手段，其重要的应用包括文物保护、医疗、机器人导航、模型生成、计算机视觉等。当然我们可以用计算机辅助设计（CAD）来建立三维模型，其优点是制作精细，但缺点是需要事先设计模型各组成部分比例，需要熟练的操作工人，开发周期长。而3D重建则基于对已有物体三维信息的采集和处理，并在此基础上建立模型，在时间成本和真实感上具有很大优势，例如人脸模型就广泛用于电影角色创建、计算机游戏外科手术、视频会议和虚拟现实等方法，对于一些需求则必须通过3D 重建实现，如历史文物保护等。

另一方面，3D打印有越来越普及的趋势。3D打印设备已经实现了产品化，其价格随着时间的推移则也越来越为普通大众接受，可以预计的是，3D 打印的风行也必将推动3D 重建技术的进一步普及和发展。而就3D重建本身来看，其实现不需要太过复杂或精密的设备，只需要简单的家用设备即可完成，甚至一种名为通过聚焦的重建方法(shape from focus)只需要一台可变焦摄像机即可。本文通过使用一台家用摄像机和一台家用投影仪，使用结构光的方法完成了3D 重建系统，结构光分为颜色序列的结构光和基于格雷码的光栅。
\section{3D重建的技术综述}
从3D重建的概念被提出到目前为止，有多种技术被提出用于重建，主要可分为接触测量和非接触测量两大类。\\
\textbf{1 接触测量法}

  此方法中，利用传感触头与被测物体的表面相接触并直接测量本点的深度信息。直接测量法的原理相当简单，且具有分辨率高，不受物体表面颜色、透明度等非形状因素干扰的优点。但其缺点是，传感触头与物体的直接接触则会一定程度地导致物体的轻微形变从而影响测量的精度，这也使得本方法不合适用于珍贵物品或极易形变物体的重建。\\
\textbf{2 非接触测量法}

  顾名思义，非接触测量法在测量中不产生与被测量物体直接的物理接触（但可能会有光或声的接触），只通过算法对被测量物体反射的声或光信息进行计算以识别物体的表面形状特性。没有物理接触可以保证对被测物体不会产生伤害，这个因素保证了非接触测量法的可使用范围要比接触测量法要更为广泛。
非接触测量法是3D测量的重要部分，其中主要的方法包含如下：
\begin{description}
  \item[]\textbf{立体成像}
人类的眼睛是天然的立体成像系统，两只眼睛在水平方向有一段差距，这段差距使得我们在观察三维物体左右眼产生视察，大脑在接收到双眼图像时检测视察并计算感知到物体的距离，从而产生立体的感受。

立体成像\cite{320548}采用与人眼一样的原理，它利用两台或多台摄像机对物体从不同角度进行拍照并交由计算机
处理并建立对应关系，再结合三角测量的原理就可以将探测得到的位置偏差转换为物体表面的三维坐标信息，
从而实现从二维空间到三维空间的转换。此方法的优点包括设备简单，
只需两台或多台家用摄像机即可，成本很低，且在测量中不与物体产生
直接接触，但其缺点是要求被测物体有足够的特征点以便能够进行识别，故
对于光滑物体其效果并不太好。

  \item[]\textbf{飞行时间法}
  飞行时间法(TOF)又被成为雷达测距，其过程是想被测物体发出经调制的激光信号，经反射后由探头接收到，
  利用相移特性计算被测物体表面到测量仪器的距离。这种方法的优点是不受物体表面颜色或环境光的干扰，
  但其要求精密的信号处理过程，对时间精度要求很高。
  \begin{figure}[!ht]
\centering
\begin{tikzpicture}
  \draw [->, very thick] (0.5,4)node[right]{\text{投射调制光}} -- (1.5,3.4);
  \draw [fill=gray!50!white](4,0) rectangle (4.2,3);
  \foreach \x in {-1,1,...,7}
    \draw [fill=gray!50!white] (0.5*\x,3.6-0.3*\x) circle (0.2);
  \foreach \x in {0,2,...,6}
    \draw [fill=gray] (0.5*\x,3.6-0.3*\x) circle (0.2);
  \draw [fill=gray!50!white](4,0) rectangle (4.2,3);
  \foreach \x in {3,5}
    \draw [fill=gray!50!white] (0.5*\x,-0.6+0.3*\x) circle (0.2);
  \foreach \x in {4,6}
    \draw [fill=gray] (0.5*\x,-0.6+0.3*\x) circle (0.2);
    \draw [->,very thick] (3,0.8) -- (2,0.11) node[below]{\text{接收调制光}};
\end{tikzpicture}
\caption{飞行时间法}
\end{figure}
  \item[] \textbf{结构光法}
  结构光法\cite{besl1988active}同样利用三角测量的原理，利用投影仪投射结构化的特征图形，并在摄像机拍摄的图像中检测
  相应特征并与所投射图像中的特征建立相应关系，随后利用三角模型计算物体表面的距离信息。该方法原理简单，
  成本低廉，可用家用摄像机和投影仪实现。结构光
  有多种选择，包括点、线和栅格图像等。结构光的选择是基于结构光的3D重建系统的基础。
\end{description}

\section{结构光技术综述}
基于结构光的3D重建系统是获取物体表面3D特性的重要方法，而其中，结构光的选择对精度、鲁棒性等因素有着
深刻的影响。最先被提出的结构光是点结构光\cite{will1972grid}，后来发展出了线结构光，很大地提升了
处理速度。到目前为止，发展出的结构光包括：基于二进制码、格雷码的时间编码结构光，基于M-arrays、De Bruijn
序列等空间编码的结构光，Salvi等在
\cite{salvi2004pattern}
中对各种形式的结构光进行了比较。

\section{本文的主要工作和研究内容}
本文实现了一个基于结构光的3D重建系统，并实现了Gray码为结构光和使用De Bruijn序列颜色条纹为结构光的两种方法。
本文提出了一系列的创新点用于调高系统对物体表面颜色和环境光的抗干扰能力，有效地提高了系统的鲁棒性和拓宽了系统
的适用范围。

第一章：对一些常用的3D重建方法进行了介绍，并介绍了结构光的原理和发展。

第二章：本章重点分析和实现了摄像机和投影仪的校正和定标，为精确实现3D测量提供准确的三角模型。

第三章：介绍了采用以De Bruijn序列编码的颜色条纹为结构光的3D重建系统，对其中的重点步骤如颜色校正、颜色线条
查找、线条颜色识别等步骤进行了重点说明。本章提出的创新点实现了高分辨率的3D重建系统，
并具有对环境光等干扰因素不敏感的特性。

第四章：介绍了采用格雷码光栅加相移图像的3D重建系统，对重点步骤提出了新的方法。

第五章：对本文所使用的方法进行总结，并讨论了进一步的改进方法。
\chapter{投影仪-摄像机系统校正}
投影仪-摄像机系统常用作三维重建系统，示意图见图~\ref{figure:system}，其优点是设备价格低廉，容易获取并安装。
在系统中，为了实现测量，需要事先对摄像机和投影仪进行定标。
\begin{figure}[!ht]
  % Requires \usepackage{graphicx}
  \centering
  \includegraphics[width=0.6\textwidth]{system.eps}
  \caption{系统结构图}\label{figure:system}
\end{figure}
\section{摄像机模型及定标}
\subsection{坐标系的定义}
对于相机模型的描述一般需要三个坐标系：世界坐标系、相机坐标系和成像平面参考系。其中世界
坐标系是在真实的环境中选取的坐标系，可以任意设置。世界坐标系选定后，物体和摄像机就拥有世界坐标系的坐标。
在接下来对坐标的描述和转换中，本文用$Q_w=[X_w\quad{}Y_w\quad{}Z_w]^T$来表示世界坐标系的一点。

摄像机是一个独立的成像系统，其成像的模型则需要用相机坐标系来描述。在相机坐标系中，坐标原点是
摄像机的光心，Z轴垂直于焦平面向外，X轴和Y轴平行于焦平面。对于相机坐标系中的一点，本文用
$Q_c=[X_c\quad{}Y_c\quad{}Z_c]^T$予以描述。

成像平面参考系建立于摄像机的成像平面上，其坐标原点是相机坐标系Z轴与成像平面的交点，这一点也被称为
摄像机的主点。理想情况下，主点应当位于成像平面的中心位置，而实际上，由于制作工艺等问题，成像平面的中心常
偏离于主点，本文用$(c_x,c_y)$来描述偏差程度，用$q=[x\quad{}y]^T$描述成像平面参考系的点。
\subsection{世界坐标系到相机坐标系的转换}
讲世界坐标系的点$Q_w=[X_w\quad{}Y_w\quad{}Z_w]^T$转换为相机坐标系$Q_c=[X_c\quad{}Y_c\quad{}Z_c]^T$的过程可以分为以下两步：
\begin{enumerate}
  \item \textbf{旋转操作} 旋转世界坐标系，使得三个轴分别与相机参考系的X、Y、Z轴平行并且反向一致
  \item \textbf{旋转操作} 平移操作 平移世界坐标系，使得世界坐标系的原点与相机坐标系的原点相重合
\end{enumerate}

定义旋转矩阵$R$来描述旋转操作，定义平移矩阵$T$来描述平移操作，世界坐标系的坐标与相机坐标系的坐标
则有如下关系：
\begin{equation}
  Q_c=R\cdot{}Q_w+T
\end{equation}
其中，R是大小为$3\times3$的正交矩阵：
\begin{equation}
  R=\left[
  \begin{array}{ccc}
    r_{11} & r_{12} & r_{13} \\
    r_{21} & r_{22} & r_{23} \\
    r_{31} & r_{32} & r_{33}
  \end{array}
  \right]
\end{equation}
T为$3\times1$大小的矩阵：
\begin{equation}
  T=[t_1\quad t_2\quad t_3]^T
\end{equation}
将从世界坐标系转换到相机坐标系的过程表示为齐次形式：
\begin{equation}
\left[
 \begin{array}{c}
 X_c\\
 Y_c\\
 Z_c\\
 1
 \end{array}
 \right]
 =\left[
 \begin{array}{cc}
 R & T\\
 0 & 1
 \end{array}
 \right]
 \left[
  \begin{array}{c}
 X_w\\
 Y_w\\
 Z_w\\
 1
 \end{array}
 \right]
\end{equation}
矩阵R和T构成了摄像机的外参数，表面世界坐标系和相机坐标系的相对位置关系。
\subsection{相机坐标系到成像平面参考系的转换}
在考虑从相机坐标系转换为成像平面参考系之前，这里先介绍摄像机的模型。
在计算机视觉中，针孔模型\cite{hartley2000multiple}被广泛用于相机模型的描述。模型假设
物体表面的反射光满足光的直线传播条件，并经过小孔投射在图形平面上，形成物体的倒像，其示意图见图~\ref{fig:nail}，
图中X为物体，x为物体的倒像，像距和物距分别为f和$Z_c$，那么显然有如下关系成立：
\begin{equation}
  -x=\frac{f}{Z_c}X
\end{equation}

\begin{figure}[!ht]
\centering
\begin{tikzpicture}
  \draw [->,dashed,dash pattern=on 1pt off 1pt] (0,0.5) -- (9.5,0.5);
  \draw (-1,-2) -- (-1,2) -- (1,3) -- (1,-1) -- cycle;
  \draw (2,-2) -- (2,2) -- (4,3) -- (4,-1) -- cycle;
  \draw [->,very thick] (9,0.5) -- (9,2.5);
  \draw [->,very thick] (0,0.5) -- (0,-0.5);
  \draw (0,-0.5) -- (9,2.5);
  \draw [dashed,dash pattern=on 2pt off 2pt] (0, -0.5) -- (0,-3);
  \draw [dashed,dash pattern=on 2pt off 2pt] (3, 0.5) -- (3,-3);
  \draw [dashed,dash pattern=on 2pt off 2pt] (9, 0.5) -- (9,-3);
  \draw [<->,dashed] (0,-2.5) -- (3,-2.5);
  \draw [<->,dashed] (9,-2.5) -- (3,-2.5);
  \draw (1.5,-2.5) node[below] {f};
  \draw (6,-2.5) node[below] {$Z_c$};
  \draw (6.5,0.5) node[below] {光轴};
  \draw (9,2.5) node[right] {X};
  \draw (0,-0.5) node[left] {x};
  \draw (-0.5,3) node {图形平面};
  \draw (2.5,3) node{针孔平面};
  \draw (3,0.5) circle (2pt);
\end{tikzpicture}
\caption{小孔成像模型}\label{fig:nail}
\end{figure}

为了简化针孔模型，将成像平面转移到针孔之前，可将针孔模型整理为一种等价形式，如图~\ref{fig:nail2}\cite{bradski2008learning}。
图中，针孔相当于投影中心，物体$Q_c$经过投影中心的光线投射到成像平面上，形成q。
\begin{figure}[!ht]
\centering
\begin{tikzpicture}
  \draw (0,0.2) node[left] {O};
  \draw (0,-0.5) node[below] {\text{针孔}};
  \draw (6,0) node[above] {\text{光轴}};
  \draw [fill=gray!50!white] (1,-3)node[right]{\text{成像平面}} -- (1,0.3) -- (5,2) -- (5,0.5) -- cycle;
  \draw[->] (0,-0.5) -- (0,4)node[above]{i};
  \draw[->] (-1,-0.5) -- (4,2) node[right]{j};
  \draw (-1,0) -- (1,0);
  \draw[dashed] (1,0) -- (3,0);
  \draw[->] (3,0) -- (8,0) node[right] {k};
  \draw[->,dashed, dash pattern=on 1pt off 1pt] (0,0) -- (8,2) node[above]{$Q_c=(X_c,Y_c,Z_c)$};
  \fill (8.03,2) circle(0.05);
  \fill (4,1) node[below] {q=(x,y,f)} circle(0.05);
  \draw (3,0) circle(0.05);
  \draw (3,0) -- (3,-0.5);
  \draw[<->,dashed,dash pattern=on 1pt off 1pt](0,-0.4) -- (3,-0.4);
  \draw (1.5,-0.4) node[below]{f};
\end{tikzpicture}
\caption{针孔模型的等价变换}\label{fig:nail2}
\end{figure}

图~\ref{fig:nail2}中的针孔即为投影中心，但在实际的相机中，芯片的中心通常不位于光轴上。中心的偏差可以
引进参数$c_x$和$c_y$来描述，同样引入两个不同的焦距：$f_x$和$f_y$来描述两个方向上的焦距，
于是将物体$Q_c(X_c,Y_c,Z_c)$和像体q($x,y,f_x,f_y$)的数学关系描述为：
\begin{eqnarray}\label{eq:inner0}
  x=X\frac{f_x}{Z_c}+c_x \nonumber\\
  y=Y\frac{f_y}{Z_c}+c_y
\end{eqnarray}
将公式~\ref{eq:inner0}使用其次坐标重新表示为：
\begin{equation}\label{eq:camera2ccd}
  q=MQ_c
\end{equation}
其中，$q=\left[\begin{array}{c}
x\\
y\\
z
\end{array}\right]$，
$Q_c=\left[\begin{array}{c}
X_c\\
Y_c\\
Z_c
\end{array}\right]$，
$M=\left[\begin{array}{ccc}
f_x & 0 & c_x\\
0 & f_y & c_y\\
0 & 0 & 1
\end{array}\right]$。

公式~\ref{eq:camera2ccd}表明了从相机坐标系到成像平面参考系的转换过程，矩阵$M$包含相机内部参数的描述，
故也被称作摄像机的内矩阵\cite{heikkila1997four}。
对摄像机定标的过程就是求得相机内参数与外参数的过程。
\subsection{摄像机畸变}
虽然摄像机可简化为针孔模型，然而在实际上，真实的针孔无法为在短时间内为曝光收集足够的光线，
因此在摄像机中使用透镜而非小孔。透镜的使用使得快速曝光成为可能，而其缺点则是引入了透镜的畸变。
透镜的畸变主要分为两种：径向畸变和切向畸变\cite{fryer1986lens}。径向畸变是由透镜形状引起，而切向畸变则由摄相机的组装过程引起。

径向畸变分为筒形畸变和枕形畸变，在光学中心的畸变程度为0，越往感光元件的边缘移动，
畸变程度越显著，参见图~\ref{fig:tongx}。通常，与整幅图片相比，这样的畸变程度比较小，可利用光学中心($r=0$)位置
周围的泰勒级数展开来近似描述，通常只取前两项或三项就足够了。假设$(x_{corrected},y_{corrected})$表示由
点$(x,y)$校正后的位置，那么有如下公式：
\begin{eqnarray}
  x_{corrected}=x(1+k_1r^2+k_2r^4) \nonumber\\
  y_{corrected}=y(1+k_1r^2+k_2r^4)
\end{eqnarray}
注意上式中没有出现r的奇次方项，这是由畸变程度$\Delta{}r$是$r$级数展开这个关系决定的。
\begin{figure}[!ht]
\centering
\begin{tikzpicture}
  \draw [thick,smooth cycle] plot coordinates {(-1,-1) (-1,1) (1,1) (1,-1)};
  \draw[thick] (-3,-1.4) node[below]{\text{透镜}} arc (200:160:4);
  \draw[thick] (-3,-1.4) arc (340:360:4) arc (0:20:4);
 % \draw (-3,1)  arc (20:0:4);
  \draw [thick] (-7,-1) -- (-7,1) -- (-5,1) -- (-5,-1) -- cycle;
  \draw[thick,->,dashed] (-4.5,0) -- (-1.5,0);
  \draw (-6,-1) node[below]{\text{物体}};
  \draw (0,-1.2) node[below]{\text{畸变图}};
\end{tikzpicture}
\caption{筒形畸变}\label{fig:tongx}
\end{figure}

另一个常用的畸变是切向畸变，这是由于透镜不完全平行于图像平面的时候所产生的，示意图见图~\ref{fig:qiex}。
引入两个额外的参数$p_1$、$p_2$来描述，
得到如下的关系\cite{2055106}：
\begin{eqnarray}
  x_{corrected}=x+[2p_1y+p_2(r^2+2x^2)] \nonumber \\
  y_{corrected}=y+[p_1(r^2+2y^2)+2p_2x]
\end{eqnarray}
\begin{figure}[!ht]
\centering
\begin{tikzpicture}
  \draw [fill=gray!50!white] (-1,0) -- (-1,5) -- (5,5) -- (5,0) -- cycle;
  \draw[thick] (3,2.5) [thin]-- (1,1) node[below]{\text{透镜}} arc (200:160:4) ;
  \draw[thick] (1,1) arc (340:360:4) arc (0:20:4)[thin] -- (3,2.5);
  \draw[thick,fill=gray!30!white] (1,1)  arc (340:360:4) arc (0:20:4) arc(160:200:4);
  \draw[fill=white,rotate around={-10:(3,2.5)}] (3,1) rectangle (3.1,4);
  \draw (3,1) node[below] {\text{感光元件}};
\end{tikzpicture}
\caption{摄像机结构，感光元件与透镜不平行}\label{fig:qiex}
\end{figure}

\subsection{摄像机定标}
摄像机定标的目标是求得摄像机的内参数、外参数和畸变的校正参数，分为内部参数(包括$f_x,f_y,c_x,c_y,k1,k2,p1,p2$)和
外部参数(包括$R,T$)。本系统使用棋盘格作为定标物，调用openCV摄像机校正函数实现摄像机定标。
\begin{figure}[!ht]
\centering
    \includegraphics[width=0.7\textwidth]{chessboard_src.eps}
    \caption{棋盘格作为定标板} \label{fig:chessboard_src}
\end{figure}

\begin{figure}[!ht]
\centering
    \subfloat[]{
    \includegraphics[width=0.32\textwidth]{1.eps}}
    \subfloat[]{
    \includegraphics[width=0.32\textwidth]{6.eps}}
    \subfloat[]{
    \includegraphics[width=0.32\textwidth]{3.eps}}\\
    \subfloat[]{
    \includegraphics[width=0.32\textwidth]{8.eps}}
    \subfloat[]{
    \includegraphics[width=0.32\textwidth]{5.eps}}
    \subfloat[]{
    \includegraphics[width=0.32\textwidth]{2.eps}}\\
    \subfloat[]{
    \includegraphics[width=0.32\textwidth]{7.eps}}
    \subfloat[]{
    \includegraphics[width=0.32\textwidth]{4.eps}}
    \subfloat[]{
    \includegraphics[width=0.32\textwidth]{9.eps}}
  \caption{棋盘格中找到的角点}\label{fig:chessboard_srcs}
\end{figure}
本文的定标板如图~\ref{fig:chessboard_src}所示，一幅图像中共有$7\times7$个角点，即每两个深色方块的接触点。
每个方块的边长为3cm，将左上角的第一个角点设定为世界坐标系的原点，X 轴和Y轴平行于定标板，Z轴垂直于定标板向外。
根据角点的相对关系，很容易确定定标板上每个角点的世界坐标系坐标。图~\ref{fig:chessboard_srcs}是校正摄像机所使用
的9幅定标图像，图中彩色点是从摄像机
拍摄到图像中检测到的角点，其在图像中的位置可以确定成像平面坐标系的坐标，由此建立世界坐标系和成像平面坐标系的
多个点对，并以此计算相机的内外参数。本文中这些参数的计算是调用openCV库中的cvCalibrateCamera2函数实现。\\
openCV计算畸变参数的函数为:\\
void cvCalibrateCamera2( const CvMat* object\_points, const CvMat* image\_points,\\
\mbox{\hspace{5.2cm}}const CvMat* point\_counts, CvSize image\_size,\\
\mbox{\hspace{5.2cm}}CvMat* intrinsic\_matrix, CvMat* distortion\_coeffs,\\
\mbox{\hspace{5.2cm}}CvMat* rotation\_vectors=NULL,\\
\mbox{\hspace{5.2cm}}CvMat* translation\_vectors=NULL,\\
\mbox{\hspace{5.2cm}}int flags=0 );

cvCalibrateCamera2函数l依据张正友提出的算法\cite{zhang2000flexible}，以角点在世界坐标系和成像平面参考系中的坐标对为输入，输出则包含内参数矩阵$M$、 畸变系数($k_1,k_2,p_1,p_2$) 以及
外参数的旋转矩阵R和平移矩阵T。内参数矩阵和
外参数矩阵描述了世界坐标系和摄像机成像平面参考系之间的转换关系，而畸变系数可用于对摄像机拍摄图像进行的畸变校正。在openCV库中，畸变校正可通过调用函数cvUndistort2、函数cvInitUndistortMap和函数cvRemap 实现。
\section{投影仪定标}
摄像机定标后要进行投影仪定标。因为投影仪模型可以认为是相机模型的逆过程，即将2D图像映射为3D光线的过程，所以其
定标过程与相机定标方法类似，同样需要在世界坐标系和投影图像平面参考系之间建立多个点对。投影图像平面参考系中点的坐标
已知，而世界坐标系中点的坐标则需要借助已定标的照相机完成。

定标板四周的四个角点经过摄像机检测以确定定标板的位置，而后将投影图像投射至定标板：
\begin{figure}[!ht]
  \centering
    \includegraphics[width=0.8\textwidth]{pc.eps}
  \caption{投影仪定标中3D点与2D点的对应关系}\label{fig:pc}
\end{figure}

在图~\ref{fig:pc}中，摄像机拍摄到投射了定标图像的定标板，并检测到一个角点$q_c$，
根据已经定标的相机坐标系和成像平面参考系可推出世界坐标系中三维点$Q_w$的坐标，
而在设计投影图像时可知投影图像中角点$q_p$在投影图像平面参考系的坐标，由此建立
$Q_w$和$q_p$的坐标对应关系，并据此完成投影仪的定标。

总的来看，将摄像机定标和投影仪定标可表述为以下流程：
\begin{enumerate}
  \item 架设摄像机、投影仪，并将其焦距调整合适，将定标板置于摄像机和投影仪视野下。
  \item 摄像机拍摄定标板图像(记为$I_c$)并检测角点，
  并匹配和记录角点在图像中的坐标、在世界坐标系的坐标，如定标板上角点未被全部检测出则重新拍摄图像，直至全部角点被检测出。
  \item 定标板不动，在其表面铺设白纸，投影仪投射投影仪定标图像，见图~\ref{fig:pro-cam}。
  \item 摄像机拍摄图像(记为$I_p$)提取投影图像的角点，记录角点在所拍摄图像中的位置，如角点未被全部检测出则重新拍摄$I_p$。
  \item 适度改变定标板位置和角度。
  \item 重复步骤2-5共9次，调用cvCalibrateCamera2函数处理步骤2得到的角点坐标对，计算摄像机内外参数，完成摄像机定标
  \item 根据摄像机参数计算投影图像角点的三维信息，
      建立投影图像角点在世界坐标系下和投影图像下的坐标对，同样调用cvCalibrateCamera2函数计算投影仪内外参数，完成投影仪定标。
\end{enumerate}
\begin{figure}[!ht]
  \centering
    \includegraphics[width=0.8\textwidth]{pro.eps}
  \caption{投影仪投射定标图像后的定标板及找到的角点}\label{fig:pro-cam}
\end{figure}

\section{三维信息的计算}
基于投影仪-摄像机的三维重建系统可简化为如下模型：
\begin{figure}[!ht]
\centering
\begin{tikzpicture}
  \draw [smooth cycle,thick, fill=yellow!50!white] plot coordinates {(2,2) (2.3,3)
   (2,4) (2.6,4.2) (2.4,5) (2.8,5.45) (3,5.5) (3.2,5.45) (3.6,5) (3.4,4.2) (4,4) (3.8,3) (4,2)};
\draw [color=blue,thick] (0,0) -- (3,3) -- (6,0);
\draw [fill=red] (0,0) circle (0.1) node[below] {\text{投影仪光心}$q_1$};
\draw [fill=red] (6,0) circle (0.1) node[below] {\text{摄像机光心}$q_2$};
\draw [fill=red] (3,3) circle (0.1) node[above] {\text{交汇点}$p$};
\draw [very thick,->,color=red] (0,0) -- (1,1) node[left]{$v_1$};
\draw [very thick,->,color=red] (6,0) -- (5,1) node[right]{$v_2$};
\draw (3,5.5) node[above]{\text{被扫描物体}};
\draw (0,1.5) node{\text{投影仪光线}};
\draw (6,1.5) node{\text{摄像机光线}};
\end{tikzpicture}
\caption{三角测量的简化模型}
\end{figure}
经过定标，投影仪的光心$q_1$、摄像机光心$q_2$在世界坐标系下的坐标均为已知。摄像机光线与投影仪光线相交于物体
表面上的p点，方向向量分别为$v_1$和$v_2$。容易推断得到如下关系：
\begin{eqnarray}
  p=q_1+\lambda_1\cdot{}v_1 \nonumber \\
  p=q_2+\lambda_2\cdot{}v_2
\end{eqnarray}
根据以上的两式可以计算出$\lambda_1,\lambda_2$，进而计算出p在世界坐标系的坐标。

在实际的情况中，摄像机光线与投影仪光线并不一定会相交，这种情况下上述两式无法解出。
解决办法是，求出$\lambda_1,\lambda_2$，使得如下的目标函数最小：
\begin{equation}
  \|(q_2+\lambda_2v_2)-(q_1+\lambda_1v_1)\|^2
\end{equation}
求解可得：
\begin{equation}
  \left[
  \begin{array}{c}
  \lambda_1\\
  \lambda_2
  \end{array}
  \right]=\left[
  \begin{array}{cc}
  \|v_1\|^2 & -v_1^tv_2 \\
  -v_2^tv_1 & \|v_2\|^2
  \end{array}
  \right]^{-1}
  \left[
  \begin{array}{c}
  v_1^t(q_2-q_1)\\
  v_2^t(q_1-q_2)
  \end{array}
  \right]
\end{equation}
\section{本章总结}
本章首先介绍了三角测量的数学原理，指出实现三角模型的精确计算需要预先知晓的摄像机与投影仪的相对位置关系，其次
介绍了摄像机的成像模型和基于定标板的定标方法，并实现了投影仪的定标。投影系统的定标是实现精确3D重建的数学基础。
\chapter{结构光为颜色条纹序列的3D重建}
本章介绍以De Burijn序列为编码颜色条纹作为结构光的3D重建方法，能够实现在环境光下
对物体的3D扫描。本文在此系统中提出了较多的创新点，包括提出对被扫描物体表面的反射率校正方法、
提出局部趋势变换的概念并用于线条检测、峰值定位方法以及改进动态规划的cost函数并用以建立投射
特征和被检测特征间的对应关系建立等。以上的创新方法使得系统具备一定对环境光和被扫描物体表面颜色的抗干扰能力，
很好地扩展了系统的适用范围。同时所采用的高分辨率投影仪也使3D重建具有很高的分辨率，例如
重建后一幅人脸的点云包含了多达75371个三维点。
\section{系统}
\subsection{架构和流程}
所使用的设备是：
\begin{itemize}
  \item 投影仪: Acer H7350D （1920*1080 分辨率）
  \item 摄像机: Nikon D200
\end{itemize}

整个3D重建的流程表述如下\cite{zhou2012adaptive}：
\begin{enumerate}
  \item 投射颜色序列， 并在环境光下抓取图像
  \item 摄像机及投影仪畸变校正
  \item 颜色校正， 包括crosstalk校正和反射率校正
  \item 分离线条并进行峰值定位
  \item 颜色识别并找出识别出的特征与所投射特征的对应关系
  \item 计算3D点云信息， 并进行后续处理
\end{enumerate}
\subsection{特征投影}
为了方便地建立投影特征和检测特征之间的对应关系， 本文根据De Bruijn 序列来设定线条颜色。
一个拥有5个元素、3阶的De Bruijn序列为：
4 4 4 3 4 4 2 4 4 1
4 4 0 4 3 3 4 3 2 4 3 1 4 3
0 4 2 3 4 2 2 4 2 1 4 2 0 4
1 3 4 1 2 4 1 1 4 1 0 4 0 3
4 0 2 4 0 1 4 0 0 3 3 3 2 3
3 1 3 3 0 3 2 2 3 2 1 3 2 0
3 1 2 3 1 1 3 1 0 3 0 2 3 0
1 3 0 0 2 2 2 1 2 2 0 2 1 1
2 1 0 2 0 1 2 0 0 1 1 1 0 1
0 0 0。
投射的颜色选择见表~\ref{tabular:colorAssignment}， 注意选取的颜色中排除了白色和黄色，排出白色是因为
线条检测和颜色识别的特殊需要，而排除黄色的原因是， 黄色与人的肤色相近，在对人体扫描时容易引进干扰。
结合De Bruijn序列和各元素颜色可以生成投影背景，见图~\ref{figure:project_background}。
\begin{table}[!ht]
\setbox0\hbox{\verb/\/}%
\caption{投影颜色选择}
\label{tabular:colorAssignment}
\begin{center}
\begin{tabular}{lll}
\hline
\textbf{编码}  & \textbf{颜色$(R,G,B)$} & \textbf{色度}\\
\hline
%\texttt{referee}       & initial submission (typeset in one column)\\
%\hline
\texttt{0}         & \textsf{$(255,0,0)$} & \textsf{$0^\circ$}\\
\texttt{1}         & \textsf{$(0,255,0)$} & \textsf{$60^\circ$}\\
\texttt{2}         & \textsf{$(0,0,255)$} & \textsf{$120^\circ$}\\
\texttt{3}         & \textsf{$(0,255,255)$}& \textsf{$180^\circ$}\\
\texttt{4}         & \textsf{$(255,0,255)$}& \textsf{$240^\circ$}\\
\hline
\end{tabular}%
\end{center}
\end{table}

\begin{figure}[!ht]
  \centering
  \includegraphics[width=\textwidth]{project_background.eps}
  \caption{投影背景}\label{figure:project_background}
\end{figure}

\section{crosstalk校正}
总体上讲， 影响系统稳定性的因素包括以下几个：
\begin{enumerate}
  \item 投影仪及摄像机存在的crosstalk现象
  \item 环境光
  \item 通常， 物体表面对不同颜色通道具有不同的反射率
  \item 拍摄到的图像中， 颜色线条的宽度和强度会受到物体表面的崎岖特性的影响
\end{enumerate}

为了提高系统的鲁棒性， 需要对以上的干扰因素采取措施。 其中的一个方法是进行颜色校正。
颜色校正包括两步：crosstalk校正消除颜色通道间的crosstalk现象；反射率校正以使个颜色通道的反射率出在相同水平

认为颜色系统的模型为公式~\ref{eq:color_model}\cite{caspi1998range}：

%%%%%%%%%C=AKP+O%%%%%%%%%%%%%%
\begin{equation}
\underbrace{\left[
  \begin{array}{c}
    c^{r} \\
    c^{g} \\
    c^{b} \\
  \end{array}
\right]}_{I_c} = \underbrace{\left[
  \begin{array}{ccc}
x_{rr} & x_{rg} & x_{rb} \\
x_{gr} & x_{gg} & x_{gb} \\
x_{br} & x_{bg} & x_{bb} \\
  \end{array}
\right]}_{X} \underbrace{\left[
  \begin{array}{ccc}
a^{r} & 0     & 0\\
0     & a^{g} & 0\\
0     & 0     & a^{b} \\
  \end{array}
\right]}_{A} ( \underbrace{\left[
  \begin{array}{c}
p^r\\
p^g\\
p^b \\
  \end{array}
\right]}_{I_p} + \underbrace{ \left[
  \begin{array}{c}
o^r\\
o^g\\
o^b\\
  \end{array}
\right]}_{O} ) \label{eq:color_model}
\end{equation}
这里的$X$矩阵为crosstalk矩阵，可以在暗室环境中通过投影 RGB 三幅纯色图至纯白色物体并计算拍摄到图片的颜色误差得到。
矩阵$A$为各颜色通道的反射率。
\section{相对反射率校正}
\subsection{相对反射率对观测的影响}
公式~\ref{eq:color_model}中的矩阵$A$为反射率矩阵，经过简单转换，可以得到：
\begin{equation}
\label{eq:ra} A = \left[
\begin{array}{ccc}
a^r  &  0                  & 0   \\
0    & \alpha a^r   & 0   \\
0    &  0                  & \beta a^r
\end{array}
\right] =a^r  \left[
\begin{array}{ccc}
1  &  0                  & 0   \\
0    & \alpha    & 0   \\
0    &  0                & \beta
\end{array}
\right]
\end{equation}
公式~\ref{eq:ra}中的$\alpha$、$\beta$分别为G通道、B通道相对R通道的相对反射率， $a^r$代表R通道的反射率。
为了进行颜色校正，对公式\ref{eq:color_model}进行转换，并将公式~\ref{eq:ra}代入得到：
\begin{eqnarray}
\label{eq:calibrated}
% \nonumber to remove numbering (before each equation)
  I_{p} + O &=& \tilde{A}^{-1} X^{-1} I_{c} \\ \nonumber
   &=& {a^{-r}} {\left[
\begin{array}{ccc}
1  &  0                  & 0   \\
0    & \tilde{\alpha}    & 0   \\
0    &  0                & \tilde{\beta}
\end{array}
\right]}^{-1}{X^{-1}}I_{c}
\end{eqnarray}
公式~\ref{eq:calibrated}中的$\tilde{A}$ 由 $\tilde{\alpha}$、$\tilde{\beta}$组成， 前者是$A$的近似估计， 而后者分别是
G、 B通道相对于R通道的相对反射率估计。 下文介绍$\tilde{\alpha}$、$\tilde{\beta}$的计算方法。

令$I_a$代表经过crosstalk校正和相对反射率校正后的颜色值，可以得到：
\begin{eqnarray}
\label{eq:calibrated1}
% \nonumber to remove numbering (before each equation)
  I_{a} &=& a^r (I_p + O) \\ \nonumber
    &=& {\left[
\begin{array}{ccc}
1  &  0                  & 0   \\
0    & \tilde{\alpha}    & 0   \\
0    &  0                & \tilde{\beta}
\end{array}
\right]}^{-1}{X^{-1}}I_{c}
\end{eqnarray}
观察公式~\ref{eq:calibrated1}得到，经过crosstalk校正和相对反射率校正的颜色$I_a$由3部分组成：
\begin{itemize}
  \item 投影颜色$I_p$
  \item 环境光 $O$
  \item R通道反射率$a^r$
\end{itemize}

$I_a$中虽然仍保留有环境光和R通道的反射率这两个干扰因素， 但已经排除了crosstalk现象和不同反射率的影响。 $I_a$也是作为特征检测的直接输入。 在特种检测中， 更多的策略被采用以消除环境光和$a^r$对线条检测和颜色识别的影响。
而为了计算$I_a$， 不仅需要进行crosstalk校正， 还要进行相对的反射率校正。 实际系统中， EMD(Earth Mover Distance)\cite{rubner2000earth}方法被用来分析颜色直方图并估算相对反射率。

\subsection{相对反射率的计算}
物体表面上G通道相对于R通道的相对反射率$\tilde{\alpha}$的计算方法是， 首先建立Ｒ通道和Ｇ通道各自的直方图，进而在直方图之间建立流动矩阵，通过分析流动矩阵的值
可以实现相对反射率的估计。

考虑$H^r$ 代表R通道的直方图，如下：
\begin{equation}
\label{eq:H}
H^r=\{(H^r_1,W^r_1),(H^r_2,W^r_2),\cdots,(H^r_n,W^r_n)\}
\end{equation}
其中，$H^r_i(1\le{}i\le{}n)$直方图的灰度值， $W^r_i(1\le{}i\le{}n)$是对应灰度的像素个数。 假设r、g和b分别代表红、绿和蓝通道，
首先$H^g$被转换为$H^{g'}$，$H^{g'}$作为$H^r$的最好匹配，并且其转换过程可表示为流矩阵的形式: $\mathbf{f}={f_{ij}(1\le{}i\le{}n,1\le{}j\le{}n)}$；齐次是计算流矩阵f以描述从$H^g$到$H^{g'}$的转换过程。
f可通过最小化以下的目标函数求得，目标函数表示为公式~\ref{eq:cost}。
\begin{equation}\label{eq:cost}
cost(H^g,H^r)=\sum_{i=1}^{n}{\sum_{j=1}^{n}{|j-i|f_{ij}}}
\end{equation}
这里的$f_{ij}$代表从$H^g_i$到$H^r_j$的流， $|j - i|$ 代表流动距离。上述目标函数的约束为公式~\ref{eq:cons1}到公式~\ref{eq:cons4}。
\begin{equation}\label{eq:cons1}
f_{ij}\ge{0} \textrm{ for } 1\le{}i\le{}n,1\le{}j\le{}n
\end{equation}
\begin{equation}
\sum_{i=1}^{n}{f_{ij}}\le{}W^r_j,1\le{}j\le{}n
\end{equation}
\begin{equation}
\sum_{j=1}^{n}{f_{ij}}\le{}W^g_i,1\le{}j\le{}n
\end{equation}
计算流矩阵的目标函数可以表示为：
\begin{equation}\label{eq:cons4}
\sum_{i=1}^{n}{\sum_{j=1}^{n}{f_{ij}}}=\min(\sum_{i=1}^{n}{W^g_i},\sum_{j=1}^{n}{W^r_j})
\end{equation}
流矩阵$\mathbf{f}$中， $f_{ij}$代表从i灰度级搬移到j灰度级的像素个数。于是相对反射率估算公式为：
\begin{equation} \label{eq:ratio}
%\tilde{\alpha}=\frac{\sum_{i=1}^{n}{\sum_{j=1}^{n}{(f_{ij}i}})}{\sum_{i=1}^{n}{\sum_{j=1}^{n}{(f_{ij}j)}}}
\tilde{\alpha}(i)=\frac{(\sum_{j=1}^nf_{ij})i}{\sum_{i=1}^n\sum_{j=1}^n(f_{ij}j)}
 ,1\leq i \leq n,1\leq j \leq n
\end{equation}
B通道的相对反射率可通过相似的过程求得，这里不再叙述。
\subsection{反射率校正的结果}
反射率校正的目的是通过校正使得RGB通道的反射率处于相同水平。图~\ref{FIG_AC}中，(a)(b)分别是反射率前后的图片，
(c)(d)是对应的各通道直方图。可以清晰看到，(a)中颜色不鲜艳、不明朗，对应的直方图中，R通道具有比G，B通道更高的
亮度。而经过反射率校正后，(d)中的RGB通道的亮度分布基本相似。
\begin{figure}[!ht]
  \centering
  \subfloat[]{
    \label{fig:FIG_AC:a} %% label for first subfigure
    \includegraphics[width=2.5in]{fig1a.eps}}
  \vspace{0in}
  \subfloat[]{
    \label{fig:FIG_AC:b} %% label for second subfigure
    \includegraphics[width=2.5in]{fig1b.eps}}
  \hfill \\
  \subfloat[]{
    \label{fig:FIG_AC:c} %% label for second subfigure
    \includegraphics[width=2.5in]{fig1c.eps}}
  \vspace{0in}
  \subfloat[]{
    \label{fig:FIG_AC:d} %% label for second subfigure
    \includegraphics[width=2.5in]{fig1d.eps}}
   \caption{反射率校正的结果. (a) 加照了结构光的脸部模型, (b) 反射率校正后的图像, (c),
(a)的直方图, (d), (b)的直方图.} \label{FIG_AC}
\end{figure}

由于校正了颜色的畸变，反射率校正同样提高了颜色的识别精度。图~\ref{fig:colorClassify}对比了反射率校正前后的
颜色识别准确率，经过反射率校正，颜色识别的准确率提高了16.18\%。
\begin{figure}[!ht]
  % Requires \usepackage{graphicx}
  \centering
  \includegraphics[width=4.0in]{ColorCorrectRatio.eps}
  \caption{颜色校正前后的颜色识别准确性比较.}
  \label{fig:colorClassify}
\end{figure}

\section{特征识别}
crosstalk校正和反射率校正的目的是校正所拍摄图片的颜色畸变，以便更准切地检测到所投影特征：线条位置及其颜色。
为了能够提高检测颜色线条的
召回率和准确率，本文引入了了两个概念：$M$ 通道和离散趋势变换。
$M$通道是指将R、G、B三个通道融合为一个通道，避免了分别处理R、G、B 三个通道的复杂性，同时结合所投射颜色序列的特殊性， 最大限度地保留了原始线条的
特征，另外，$M$通道的定义也使其具有一定去背景光干扰的能力。离散趋势变换将$M$通道中线条的变化特性转换为更易检测的形式， 很大程度上提高了线条检测成功率。
\subsection{$M$ 通道定义}
$M$通道被定义为当前像素下， R、G、B三个通道的最大值与最小值之差， 如公式~\ref{eq:Mchannel}\cite{zhao2011novel}。
\begin{equation}
\label{eq:Mchannel}
M_{ij}=\max{(C^r_{ij},C^g_{ij},C^b_{ij})}-\min{(C^r_{ij},C^g_{ij},C^b_{ij})}
\end{equation}
这里的$C_{ij}$是公式~\ref{eq:calibrated1}中$I_a$图像中的像素值，即颜色校正后的像素值。接下来的处理如中心线查找和峰值定位都是基于
$M$通道进行的。 $M$通道的定义形式决定了其具有排除环境光干扰的能力，其证明见公式~\ref{eq:Cij}和公式~\ref{eq:Mij}。

根据公式~\ref{eq:calibrated1}， $C_{ij}$具有如下形式：
\renewcommand{\arraystretch}{1.3}
\begin{equation}
\label{eq:Cij} \left[
\begin{array}{c}
C^r_{ij} \\
C^g_{ij} \\
C^b_{ij}
\end{array}
\right] = a^r \left[
\begin{array}{c}
p^r_{ij}+o^r_{ij} \\
p^g_{ij}+o^g_{ij} \\
p^b_{ij}+o^b_{ij}
\end{array}
\right]
\end{equation}
将公式~\ref{eq:Cij}代入公式~\ref{eq:Mchannel}， 并认为环境光主要有白色光组成，
即$o^r_{ij}\approx{}o^g_{ij}\approx{}o^b_{ij}$， 可以得到：
\begin{eqnarray}
\label{eq:Mij} M_{ij} & = & a^r\max{ \left[
\begin{array}{c}
p^r_{ij}+o^r_{ij} \\
p^g_{ij}+o^g_{ij} \\
p^b_{ij}+o^b_{ij}
\end{array}
\right] } - a^r\min{ \left[
\begin{array}{c}
p^r_{ij}+o^r_{ij} \\
p^g_{ij}+o^g_{ij} \\
p^b_{ij}+o^b_{ij}
\end{array}
\right]}
\nonumber \\
& = & a^r \max{ \left[
\begin{array}{c}
p^r_{ij} \\
p^g_{ij} \\
p^b_{ij}
\end{array}
\right] } - a^r\min{ \left[
\begin{array}{c}
p^r_{ij} \\
p^g_{ij} \\
p^b_{ij}
\end{array}
\right] }
\nonumber \\
& = & a^r\max{ \left[
\begin{array}{c}
p^r_{ij} \\
p^g_{ij} \\
p^b_{ij}
\end{array}
\right]}
\end{eqnarray}
注意公式~\ref{eq:Mij}中存在如下关系：
\begin{equation}
    \min({[p^r_{ij}\hspace{10pt}p^g_{ij}\hspace{10pt}p^b_{ij}]}^T) = 0
\end{equation}
这是因为，所投射的各颜色的R、G、B三个通道之中中，至少存在一个为 0 的通道。具体可参看表~\ref{tabular:colorAssignment}。
\begin{figure}[!ht]
\centering
\subfloat[]{
    \includegraphics[width=0.4\textwidth]{de_src.eps}
}
\subfloat[]{
    \includegraphics[width=0.4\textwidth]{de_m.eps}
}
\caption{(a) 加照了光栅的手\quad()(b)将(a)转换后得到的M通道图}\label{fig:de_m}
\end{figure}
从以上的推演可见，$M$ 通道只和两个因素相关：
\begin{itemize}
  \item 投影颜色$I_p$
  \item R通道反射率$a^r$
\end{itemize}
$M$通道与环境光 $O$ 无关。

\subsection{离散趋势变换}
在$M$通道的基础上，为了进一步排除R通道反射率对中心线查找的影响，本文提出离散趋势变换(DTT)的概念。
离散趋势变换被定义为如下形式\cite{onoz2003power}：
\begin{equation}\label{eq:LTM}
T_{ij}=\sum_{k=h+1}^{j+N}{\sum_{h=j}^{j+N-1}{sign(M_{ik}-M_{ih})}}
\end{equation}

\renewcommand{\arraystretch}{1}
\begin{equation}
\label{eq:sign} sign(a)= \left\{
\begin{array}{lc}
1  & a > 0 \\
0  & a = 0 \\
-1 & a < 0
\end{array}
\right.
\end{equation}
其中的$N$为窗口大小， 实际应用中窗口大小可设定线条平均宽度的一半。 考虑窗口大小远小于图像尺寸的实际因素，
则以下条件近似成立： $a^r_{ik}\approx{}a^r_{ih}$。 此近似条件可以理解为， 在物体表面上， 相近的点具有接近的反射率。 将这个近似条件代入公式~\ref{eq:LTM}， 可以得到如下推演：
\renewcommand{\arraystretch}{1.3}
\begin{eqnarray}
\label{eq:sign1} \lefteqn{sign(M_{ik}-M_{ih}) } \nonumber\\
& = & sign(a_{ik}^r\max\left[
\begin{array}{c}
p^r_{ik} \\
p^g_{ik} \\
p^b_{ik}
\end{array}
\right] - a_{ih}^r\max\left[
\begin{array}{c}
p^r_{ih} \\
p^g_{ih} \\
p^b_{ih}
\end{array}
\right]
) \nonumber\\
& = & sign(\max( \mathbf{p}_{ik} ) - \max(
\mathbf{p}_{ih} ) ]
\end{eqnarray}
最终， $M$通道的离散趋势变换被表示为：
\begin{equation}
\label{eq:LTM1}
T_{ij}=\sum_{k=h+1}^{j+N}{\sum_{h=j}^{j+N-1}{sign(\max(\mathbf{p}_{ik})-\max(\mathbf{p}_{ih}))}}
\end{equation}
公式 (\ref{eq:LTM1}) 表达的DDT有如下性质:
\begin{itemize}
\item 在 $M$ 通道的上升沿, $T$ 达到最大值 $\frac{N(N+1)}{2}$.
\item 在 $M$ 通道的下降沿, $T$ 到达最小值 $-\frac{N(N+1)}{2}$.
\item 在非单调区间，$T$ 的值位于最大值和最小值之间.
\end{itemize}
\begin{figure}[!ht]
  % Requires \usepackage{graphicx}
  \centering
  \includegraphics[width=0.7\textwidth]{retrend1.eps}
  \caption{DTT. T(n) 代表了 f(n) 的局部趋势. T(n) 的最大值意味着 f(n) 位于上升沿， 而 T(n) 达到最小值意味着 f(n) 位于下降沿， 且 T(n) 最大值的结束点与 f(n) 的峰值点的距离恰为窗口大小 N.}\label{figure:1}
\end{figure}

\begin{figure}[!ht]
  % Requires \usepackage{graphicx}
  \centering
  \includegraphics[width=0.7\textwidth]{retrend2.eps}
  \caption{f(n) 和 T(n): 如图， f(n) 有四个符合高斯分布的峰值，各有不同的宽度和高度，在对 f(n) 实施 DTT 变换得到的 T(n) 中， 四个峰值点则对应相同的最大值到最小值的变化模式， 寻找和定位这样的变化模式可以用于回溯寻找峰值位置. }\label{figure:trendshow}
\end{figure}

DTT的另外一个重要作用是能够很好地检测出微弱线条。在实际采样的照片中，在物体边缘或表面起伏坡度较大的地方，
由于投射线条被斜向拉扯，线条变宽，
导致由投射线条所引起的亮度起伏变化较小，使用传统的以亮度作为判断标准方法很难在背景中检测到这些微弱线条。然而可想而知，
物体表面的3D信息在起伏较大区域最为集中，所以如何将线条检测准确极为重要，直接关系到3D重建的效果。
DTT之所以能够很好地处理这种情况是因为，DTT仅关注亮度的变化趋势而不关注亮度的绝对值，即通过变换，DTT将线条的
先递增、后递减趋势转换为\textbf{最大值-最小值模式}，而最大值-最小值模式只与线条的变化趋势有关，与线条的绝对亮度无关。
图~\ref{fig:segmentation}
对比了使用自适应阈值二值化方法和DTT方法分离的线条结果，
显然，在坡度较大的物体边缘区域，DTT方法检测除了绝大部分线条，而自适应阈值的二
值化方法的检测结果则存在不少漏检及断点。
\begin{figure}[!ht]
  \centering
  \subfloat[]{
   %% label for first subfigure
    \includegraphics[width=3in]{handLightLocal.eps}}
  \\
  \subfloat[]{
   %% label for second subfigure
    \includegraphics[height=2in]{centerOLD.eps}}
  \subfloat[]{
  %% label for second subfigure
    \includegraphics[height=2in]{centerNEW.eps}}
   \caption{线条检测的结果对比. (a) 原图像, (b) 自适应阈值二值化方法检测的线条, (c)使用DTT检测到的线条.}\label{fig:segmentation}
\end{figure}

\subsection{峰值定位}

在使用DTT的方法定位线条后，还需要确定线条的峰值位置以用于三维点云的计算。峰值定位的方法有多种\cite{fisher1996comparison}，一些是精确到
像素，另一些是精确到亚像素，现列举主要的方法如下。
\begin{itemize}
  \item \textbf{最大值方法} Jordi\cite{OptimisedDeBruijn} 使用线条中具有最大值得像素位置作为峰值位置， 为了便于对比结果， 将此方法
  简记为 MAX，本方法只精确到像素。
  \item \textbf{中心点方法} Thomas等\cite{GraphCut} 则使用线条的中心位置作为峰值位置， 记此方法为 MID，本方法只精确到像素。
  \item \textbf{加权平均法} Zhiqiang等\cite{CompositeColorfulStripes} 使用的峰值位置计算方法为，在整个线条区域
  之中，以各像素点的亮度为权重，对各像素的位置求取加权平均值并作为峰值位置， 记此方法为 WA，本方法将峰值位置计算到了亚像素。
  \item \textbf{概率法} Fechteler等\cite{ColorClassification} 则结合亮度、线条形状等因素，构建抛物线模型并计算峰值位置， 记此方法为 PA，本方法将峰值位置计算到了亚像素。
\end{itemize}

本文计算峰值的方法不同于以上，其主要的步骤是，在M通道和使用DTT方法确定的线条区域的基础上，寻找线条区域中
M通道值高于峰值一定比例的像素点，并对这些点加权计算均值以作为峰值位置，本文的方法记为 MMWA， 可表述为公式~\ref{eq:Iestimated}。
本方法与以上方法的区别是，首先公式~\ref{eq:Iestimated}并不以亮度直接作为权重，而是使用此像素点的$M$通道值，另外，
此方法排除了线条外围更容易受噪声影响的点。
\begin{equation}
\label{eq:Iestimated} I_{estimated}=
\frac{\sum{I_i\cdot{}M_{i}}}{\sum{I_i}},\textrm{ for } M_i \ge
\alpha{}M_{max}
\end{equation}

在实际系统中，$\alpha$选取的值为 0.6。图~\ref{figure:peak} 对比了各方法得到的峰值位置对比。
可以看到最大值方法确定的峰值位置起伏最大，本文方法检测的峰值则平顺得多。
\begin{figure}[!ht]
  % Requires \usepackage{graphicx}
  \centering
  \subfloat[]{
  \includegraphics[width=0.4\textwidth,totalheight=4cm]{IMG_SOURCE.eps}}%\hspace{0.01\textwidth}
  \subfloat[]{
  \includegraphics[width=0.4\textwidth,totalheight=4cm]{IMG_CANNY.eps}}\\
\subfloat[]{
  \includegraphics[width=0.24\textwidth,totalheight=4cm]{CANNY.eps}}\hspace{0.015\textwidth}
  \subfloat[]{
  \includegraphics[width=0.24\textwidth,totalheight=4cm]{MMWA.eps}}\hspace{0.015\textwidth}
    \subfloat[]{
  \includegraphics[width=0.24\textwidth,totalheight=4cm]{PM.eps}} \\
  \subfloat[]{
  \includegraphics[width=0.24\textwidth,totalheight=4cm]{MID.eps}}\hspace{0.015\textwidth}
  \subfloat[]{
  \includegraphics[width=0.24\textwidth,totalheight=4cm]{MAX.eps}}\hspace{0.015\textwidth}
    \subfloat[]{
  \includegraphics[width=0.24\textwidth,totalheight=4cm]{WA.eps}}
  \caption{以不同方法定位的峰值. (a)多面体. (b)线条区域. (c)放大的线条区域. (d)MMWA. (e)PA. (f)MID. (g)MAX. (h)WA}\label{figure:peak}
 % \end{center}
\end{figure}

\subsection{颜色提取}
线条颜色识别是特征识别的另一个重要部分，颜色识别的准确率直接影响特征识别的准确率。从公式~\ref{eq:calibrated1}可知， 原始图像即使经过crosstalk和相对反射率校正，仍然保留有环境光和R通道反射率的影响。以简单的RGB颜色空间对颜色识别难以做到对
上述干扰因素的免疫性。为了解决这个问题，本文将已检测到线条位置的R、G、B值转化为色度，并在hsv空间分别与5个所透射颜色的
色度相比较，若与某个投射颜色的色度相差最小且差值在阈值之内则判定线条颜色为此投射颜色。

假设某像素点具有(R,G,B)三个通道值， 且满足$R\ge{}G\ge{}B$， 那么这个点的色度表达为：
\begin{equation}\label{eq:hue}
  h=60^{o}\cdot\frac{G-B}{R-B}
\end{equation}
将公式~\ref{eq:Mij}代入公式~\ref{eq:hue}， 那么得到：
\begin{eqnarray}\label{eq:huv}
h & = & \frac{C^g-C^b}{C^r-C^b}\cdot \frac{\pi}{3} \nonumber \\
  & = & \frac{a^r(p^g+o^g)-a^r(p^b+o^b)}{a^r(p^r+o^r)-a^r(p^b+o^b)} \cdot \frac{\pi}{3} \nonumber \\
  & = & \frac{p^g-p^b}{p^r-p^b} \cdot \frac{\pi}{3}
\end{eqnarray}
由公式~\ref{eq:huv}计算得到的色度与各干扰因素均无关，有效提高了颜色识别的准确性，图~\ref{fig:de_m}(a)中
食指部分的颜色识别效果图见图~\ref{fig:de_color}。
\begin{figure}[!ht]
\centering
    \includegraphics[scale=0.5]{de_color.eps}
\caption{食指部分的线条颜色识别结果}\label{fig:de_color}
\end{figure}

\subsection{建立检测特征及投射特征间的对应关系}
完成线条检测、峰值定位和颜色识别等特征识别的步骤后，还要建立检测出特征及所投射特征间的对应关系以代入三角模型并计算三维点云。
实际中这一步是采用动态规划匹配色度的方法实现，邹润等\cite{zou2012novel}则提出了概率模型以求解概率模型。

假设$A_i,1\in[1,N]$代表投射线条序列的色度值，$B_j,j\in[1,M]$代表检测出线条序列的色度值，分两步进行$A_i$,$B_j$的匹配：
\begin{enumerate}
  \item 建立$C_{ij}(1\in[1,N],j\in[1,M])$矩阵和$P_{ij}(1\in[1,N],j\in[1,M])$路径矩阵，建立方法为：
  \begin{equation}\label{eq:cmatrix}
    C_{ij}=\max(C_{i(j-1)},C_{(i-1)j},C_{(i-1)(j-1)}+cost_{ij})
  \end{equation}
  \begin{equation}\label{eq:pmatrix}
    P_{ij}=\left\{
    \begin{array}{ll}
      \nwarrow & C_{ij}=C_{(i-1)(j-1)}+cost_{ij} \\
      \uparrow & C_{ij}=C_{(i-1)j} \\
      \longleftarrow & C_{ij}=C_{i(j-1)}
    \end{array}
    \right.
  \end{equation}
  \item 从元素$P_{MN}$开始，沿着箭头跟踪$P$矩阵，其路径中的``$\nwarrow$''对应$A_i$,$B_j$的一个匹配，``$\uparrow$''表示
  $B_j$中缺失元素，即漏检线条，``$\longleftarrow$''表示$B_j$中多出元素，即多检出了线条。
\end{enumerate}

公式~\ref{eq:cmatrix}和公式~\ref{eq:pmatrix}中的$cost_{ij}$是实现正确匹配的关键，为了鼓励连续的匹配，本文使用连续三根线条
的匹配程度作为cost值，表示为公式为：
$cost_{ij}$为：
\begin{equation}
  cost_{ij}=match(A_{i-1},B_{j-1})+match(A_i,B_j)+match(A_{i+1},B_{j+1})
\end{equation}
\begin{equation}
  match(A_i,B_j)=\left\{
  \begin{array}{lll}
  10 &  & |A_i-B_j|\le{}20 \\
    0 &  & |A_i-B_j|\ge{}40 \\
  10\times\frac{40-|A_i-B_j|}{20} &  & \text{else}\\
  \end{array}
  \right.
\end{equation}
将$match(A_i,B_j)$表示为图形为：
\begin{figure}[!ht]
\centering
  \begin{tikzpicture}
    \axises{$|A_i-B_j|$}{$match(A_i,B_j)$}{7}{4};
    \draw[very thick,color=blue] (0,3) -- (2,3) -- (4,0) -- (6.5,0);
    \draw (0,3) node[left] {10};
    \draw (2,0) node[below] {20};
    \draw (4,0) node[below] {40};
  \end{tikzpicture}
  \caption{$match(A_i,B_j)$的图形表示}
\end{figure}
\section{重建结果}
本系统的输出结果是3D点云，由于采用了颜色校正、DTT等改进方法，系统能够在非暗室的环境中正常工作，具有良好的对环境光抗干扰性能。
图~\ref{FIG_Example}展示了多面体、
手部和脸部的图像采集环境和重建结果，即使存在环境光，系统也能够利用算法针对性地排除干扰，从而正确地检测特征并计算出三维点云。系统的
另一个特点是分辨率高，图~\ref{FIG_Example}(b)(d)分别有85687和75371 个三维点。
\begin{figure}[!ht]
  \centering
  \subfloat[]{
    \label{fig:FIG_Example:a} %% label for first subfigure
    \includegraphics[width=2.5in]{handLight.eps}}
  \vspace{0in}
  \subfloat[]{
    \label{fig:FIG_Example:b} %% label for second subfigure
    \includegraphics[width=2.5in]{hand.eps}}
  \hfill \\
  \subfloat[]{
    \label{fig:FIG_Example:c} %% label for second subfigure
    \includegraphics[width=2.5in]{faceLight4.eps}}
  \vspace{0in}
  \subfloat[]{
    \label{fig:FIG_Example:d} %% label for second subfigure
    \includegraphics[width=2.5in]{result_face_pc.eps}}
  \hfill \\
    \subfloat[]{
    \label{fig:FIG_Example:e} %% label for third subfigure
    \includegraphics[width=2.5in]{HandPolyLight.eps}}
  \vspace{0in}
  \subfloat[]{
    \label{fig:FIG_Example:f} %% label for third subfigure
    \includegraphics[width=2.5in]{handpoly.eps}}

   \caption{重建结果:
(a) 手, (c) 脸, (e) 手和多面体. (b) 手的重建表面, (d) 脸的重建表面 (f) 手与多面体的重建表面.}
\label{FIG_Example}
\end{figure}
\section{本章总结}
本章实现了一种基于De Bruijn
序列编码颜色序列作为结构光的3D重建方法，介绍了一般的流程并在关键处理步骤中，如颜色校正、线条识别、峰值定位和颜色识别等方面进行了
创新，提出了DTT等概念用于特征识别，使得系统在线条检测、定位和颜色识别等方面能够取得精确的结果，同时也克服了结构光方法易受环境光干扰的缺点，使重建系统即使在环境光下很好的工作，不需要暗室环境，很大程度上提升了重建系统的使用范围。
\chapter{结构光为格雷码投影光栅的3D重建}
格雷码投影光栅是时间编码方式的3D重建，相比于空间编码，时间编码方式具有分辨率高、测量误差小的特点。
结构光为格雷码投影光栅的3D重建同样采用三角模型，系统架构与之前所述类似，此处不再重复。总体的处理步骤是：
\begin{enumerate}
  \item 投影光栅并采集图像
  \item 图像处理并提取有效区域
  \item 解码并建立对应关系
  \item 计算点的三维坐标
\end{enumerate}
\section{特征投影}
通常CCD摄像机镜头上有增透膜，增透膜的作用是减少光在进入镜头时的反射，增加进入镜头的光强。
因为人眼对偏绿的颜色敏感，大多数镜头都选择增强绿光的入射，因为采用厚度为绿光波长一半的增透膜。
这样就造成由CCD摄像机获取图像时颜色的不均匀性，所以系统使用的结构光采用绿色。

经验证，绿色比红色光等其他光在相同条件下得到的点云噪点更少且正确点更多。
\subsection{格雷码光栅}
格雷码在任意两个相邻的数之间转换时，只有一个数位发生变化。这个特性使得其码值最多有一位被误判，且任意位被误判引起的误差只有
一位。同时，由于格雷码较之二进制码器明暗光间隔要高出一倍，可有效减少明暗光线间的相互干扰。

以三幅二进制格雷码为例， 如图~\ref{figure:gray}所示：
\begin{figure}[!ht]
  \centering
  \includegraphics[width=0.8\textwidth]{gray.eps}
  \caption{格雷码投影光栅}\label{figure:gray}
\end{figure}

格雷码与十进制、二进制码的转换表如表~\ref{tabular:gray2bin}。
\begin{table}[!ht]
%\setbox0\hbox{\verb/\/}%
\caption{格雷码与实际值、二进制码的对应关系}
\label{tabular:gray2bin}
\begin{center}
\begin{tabular}{|c|c|c|}
  \hline
  \textbf{十进制}  & \textbf{格雷码} & \textbf{二进制码}\\
  \hline
  \texttt{0}         & 000 & 000 \\ \hline
  \texttt{1}         & 001 & 001 \\ \hline
  \texttt{2}         & 011 & 010 \\ \hline
  \texttt{3}         & 010 & 011 \\ \hline
  \texttt{4}         & 110 & 100 \\ \hline
  \texttt{5}         & 111 & 101 \\ \hline
  \texttt{6}         & 101 & 110 \\ \hline
  \texttt{7}         & 100 & 111 \\
  \hline
\end{tabular}%
\end{center}
\end{table}

格雷码的生成可采用递归方式实现。假如想要生成n位格雷码，则可先将n-1 位格雷码的$2^{n-1}$个编码列出，而后再以从后向前的
顺序，重新列出这n-1位格格雷码，形成形成$2^n$个序列，每个序列的长度为$n-1$。最后在前$2^{n-1}$个序列的最前补0，在后$2^{n-1}$
个序列的最前补1，这样就完成了n位格雷码的生成。分别设定格雷码中0和1 代表的颜色，并从高位向低位依次递进，形成n幅$2^{n}$位的格雷码
编码的光栅图案并投射至被扫描物体表面。拍摄到加照格雷码光栅的物体在图~\ref{fig:gray_project}中体现，从图中我们看到，后三幅的格雷码
光栅亮度转换频繁，尤其是最后一幅，亮区和暗区只占1个像素，这导致在实际处理中很难准确区分亮区和暗区。

\begin{figure}[!ht]
\centering
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_1.eps}
  }
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_2.eps}
  }
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_3.eps}
  } \\
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_4.eps}
  }
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_5.eps}
  }
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_6.eps}
  } \\
    \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_7.eps}
  }
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_8.eps}
  }
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_9.eps}
  }\\
    \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_10.eps}
  }
  \caption{投射了格雷码光栅的物体}\label{fig:gray_project}
\end{figure}

\subsection{位移码图}

在实际的系统中，除了格雷码光栅还使用了位移码光栅作为补充。这是因为，当格雷码转换频率较高时，明暗光线间隔很近，
其相互间干扰已不可避免和忽略，导致在
识别光亮区和黑暗区的处理中引入误差。为了解决这个问题，实际的系统只使用明暗间隔较大的若干幅格雷码光栅，
由此引起的分辨率缺失采用位移码标注。如在本文中采用的格雷码共10幅，理论上最高分辨率为1024，但变化频率最高的3幅处理起来相当困难，于是只采用7 幅格雷码光栅。7幅格雷码光栅的最小变化单元为8像素，于是分辨率下降为原来的八分之一，为128。
此时在格雷码光栅每个最小的变化单元之内分时8次，额外投射8条位移码以可以填补损失的分辨率，最终的水平分辨率为1024。宽度为8的位移码如图~\ref{figure:move} 所示。
\begin{figure}[!ht]
  \centering
  \includegraphics[width=0.8\textwidth]{sweep.eps}
  \caption{位移码图}\label{figure:move}
\end{figure}
\section{编码图像的处理}
\subsection{有效区域的选择}
实际上，以结构光为基础的3维重建可能会存在测量死角，即结构光无法照射到或照相机无法捕捉的区域，其示意图如图~\ref{fig:dead}。

\begin{figure}[!ht]
  \centering
  \begin{tikzpicture}
    \draw[thick] (0,0) -- (3,0) -- (3,1) -- (4,1) -- (4,0) -- (7,0);
    \draw[thick] (1.5,6) rectangle (2.5,5);
    \draw[thick] (4.5,6) rectangle (5.5,5);
    \draw (1.5,5.5) node[left] {\text{投影仪}};
    \draw (5.5,5.5) node[right] {\text{摄像机}};
    \draw (0,0) node[below] {\text{物体表面}};
    \draw (2,5) -- (4.5,0);
    \draw (2,5) -- (6,0);
    \draw (2,5) -- (1,0);
    \draw (5,5) -- (6,0);
    \draw (5,5) -- (1,0);
    \draw (5,5) -- (2.5,0);
    \draw[very thick] (4,1) -- (4,0) -- (4.5,0);
    \draw[very thick] (2.5,0) -- (3,0) -- (3,1);
    \draw (2.5,0) node[below] {A};
    \draw (3,1) node[left] {B};
    \draw (4.5,0) node[below] {D};
    \draw (4,1) node[right] {C};
  \end{tikzpicture}
  \caption{测量死角的示意图}\label{fig:dead}
\end{figure}

在图~\ref{fig:dead}中，物体表面的AB和CD部分为测量死角，其中AB部分是因为摄像机无法捕捉到，CD部分表面则是因为投影仪无法照射到。

死角的存在会在解码图像引入干扰，应事先予以标记并在解码和计算点云时排除此部分。方法在投射格雷码光栅之前投射全亮的投射光，
并通过二值化的方法检测出有效区域。图~\ref{fig:gray_valid}中，(a)是在无任何投影下的拍摄图像，(b)是投射全屏光时拍摄的图像，(c)是
提取的有效区域。
\begin{figure}[!ht]
\centering
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_background.eps}
  }
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_white.eps}
  }
  \subfloat[]{
  \includegraphics[width=0.3\textwidth]{gray_valid.eps}
  }
  \caption{有效区域提取}\label{fig:gray_valid}
\end{figure}

\subsection{解码位移图码光栅}
在解析格雷码光栅之前，本文先解码位移图码。在加照格雷码光栅之前，需要让摄像机记录在无任何光照条件下的环境图像， 记为$I_{background}$。提取位移图码的处理步骤可表示为：
\begin{enumerate}
  \item 计算 $I_{sub}=I_{move}-I_{background}$
  \item 按照原投射光中各通道的比例将$I_{sub}$中的R，G，B通道合并为单一通道，记为$I_{channel}$

     假设投射光的颜色为(R, G, B)， 那么:
     \begin{equation}
       I_{channel} = \frac{R}{R+G+B}\cdot{}I_{sub}^R+\frac{G}{R+G+B}\cdot{}I_{sub}^G+\frac{B}{R+G+B}\cdot{}I_{sub}^B
     \end{equation}
  \item 用类似颜色条纹序列中的峰值定位方法定位$I_{channel}$中的峰值
\end{enumerate}
\begin{figure}[!ht]
\centering
  \subfloat[]{
    \includegraphics[width=0.7\textwidth]{sweep_src.eps}
  }\\
  \subfloat[]{
    \includegraphics[width=0.7\textwidth]{sweep_line.eps}
  }
  \caption{位移码图像的处理 (a),拍摄到的源图像 (b),检测出的线条}\label{fig:sweep}
\end{figure}
位移图码的解析对点云的精确程度有很大影响，本处采用与颜色条纹序列中的峰值定位方法一样的算法可达到亚像素的精度。另一方面，
接下来的格雷码光栅的解析则需要用到位移图码信息。
\subsection{解码格雷码光栅}
在 $t$ 时刻拍摄到的加照格雷码光栅的图像记为 $I_{gray}$，那么处理方式步骤可列为：
\begin{enumerate}
  \item 计算 $I_{sub}=I_{gray}-I_{background}$
  \item 合并$I_{sub}$的R，G，B通道为单一通道，记为$I_{channel}$

     假设投射光的颜色为(R, G, B)， 那么:
     \begin{equation}
       I_{channel} = \frac{R}{R+G+B}\cdot{}I_{sub}^R+\frac{G}{R+G+B}\cdot{}I_{sub}^G+\frac{B}{R+G+B}\cdot{}I_{sub}^B
     \end{equation}
\end{enumerate}
  \begin{figure}[!ht]
  \centering
  \subfloat[]{
  \includegraphics[width=0.4\textwidth]{gray_6.eps}}
  \subfloat[]{
  \includegraphics[width=0.4\textwidth]{gray_ex_channel.eps}}
   % \subfloat[]{
  %\includegraphics[width=0.3\textwidth]{gray_bw.eps}}
  \caption{(a),一幅加照了格雷码光栅的物体 (b),合并为单通道} \label{figure:gray_process}
\end{figure}

图~\ref{figure:gray_process}展示了l编码图像的处理过程，(a)是摄像机拍摄到的图像，(b)是将(a)从RGB转换为灰度图后得到的
图像。

实际上，二值化图像是准确解码的关键。将一幅图像二值化的方法有多种，大致可分为全局阈值法和局部阈值法，而阈值的选择至关重要。
全局阈值法是指，选取单一的阈值，适用于整幅图像并二值化，典型的算法包括直方图变换法，OTSU法(大律法)。全局阈值法虽然简单但
却不能表现图像的细节。而局部阈值法是指，将图像按照某种规则划分为若干部分，在各部分之内选取阈值并适用于此部分以二值化。相比之下，局部阈值法虽然没有从根本上解决这个缺陷，但较全局阈值法能将细节表现地更好。

另一方面，在本系统中，稍加推理便可知道，格雷码光栅的边缘应当位于第8条位移码和相邻格雷码光栅变化单元的第1条位移码之间，也就是说，检测得到的位移码位置对格雷码光栅的边缘位置添加了约束和指导，光栅边缘的确定需要考虑光栅亮度的变化，也需要考虑位移码的约束条件。本文采用概率的方式综合考虑这两个因素并最终确定边缘位置，具体可表述为：
\begin{enumerate}
  \item 使用局部阈值法二值化$I_{channel}$，并初步确定边缘的大致位置，见图~\ref{fig:two_lines}(b)。假设被确定的边缘位置为t，那么按照高斯衰减，与t 相邻的位置i可能为边缘的概率可表示为：
     \begin{equation}\label{eq:one_edge}
      p_t(i)=e^{\left(\frac{i-t}{c_1}\right)^2}
      \end{equation}
      此处的$c_1$选择为1。
  \item 确定i附近第8条位移码和相邻格雷码光栅变化单元的第1条位移码的位置，见图~\ref{fig:two_lines}(a)，分别记为l和h，l和h为边缘位置提供了限制因素，在此约束条件下，位置i可能为边缘的概率可表示为：
      \begin{equation}\label{eq:two_line}
      p_c(i)=e^{\left(\frac{2i-l-h}{2c_2}\right)^2}
      \end{equation}
      此处的$c_z$设定为$\frac{h-l}{1}$，即l和h相距越远$p_c(i)$越平缓，反之则越陡峭。
  \item 结合上述两个因素，位置i最终可能为真正边界的概率为：
  \begin{equation}\label{eq:edge}
      p(i)=p_t(i)\cdot{}p_c(i)=e^{\left(\frac{i-t}{c_1}\right)^2}\cdot{}e^{\left(\frac{2i-l-h}{2c_2}\right)^2}
      \end{equation}
      最终，取$p(i)$最大值处的i作为格雷码光栅的最终边缘位置。
\end{enumerate}
\begin{figure}[!ht]
\centering
\subfloat[]{
\includegraphics[width=0.6\textwidth]{edge2.eps}
}\\
\subfloat[]{
\includegraphics[width=0.6\textwidth]{edge.eps}
}
\caption{(a)两条相邻的边界位移码线条 (b)阈值分割得到的边缘线}
\label{fig:two_lines}
\end{figure}

图~\ref{fig:two_lines}(a)是两条相邻的边界位移码线条，理想情况下格雷码光栅的边缘应位于线条之间，按照式~\ref{eq:two_line}将其转化为图~\ref{fig:fig}(a)。图~\ref{fig:two_lines}(b)是二值化得到的边界位置，按照式~\ref{eq:one_edge} 将其转化为图~\ref{fig:fig}(b)，最终按照式~\ref{eq:edge}合并得到图~\ref{fig:fig}(c)并取其最大位置为格雷码光栅的边界，效果见图~\ref{fig:edge_result}。

\begin{figure}[!ht]
\centering
\begin{tikzpicture}
  \draw [->] (-0.1,0) node[below]{0} -- (6,0) node[below]{i};
  \draw [->] (0,-0.1) -- (0,2) node[left] {$p_t$};
  \draw [color=blue,domain=0:6,thick,smooth] plot[id=exp] function{2*exp(-(x-3)*(x-3))};
 %\draw [color=blue,domain=0:5,thick] plot (\x,{2*exp(-(\x-3)*(\x-3))});

  \draw [->] (-0.1,2.5) node[below]{0} -- (6,2.5) node[below]{i};
  \draw [->] (0,2.4) -- (0,4.4) node[left] {$p_c$};
  \draw [color=blue,domain=0:6,thick,smooth] plot[id=exp] function{2*exp(-(x-2.5)*(x-2.5)*2)+2.5};
 % \draw [color=blue,domain=6:11,step=0.001] plot (\x, {2*exp(-(\x-7.7)*(\x-7.7)*4)});

 \draw [->] (-0.1,-2.5) node[below]{0} -- (6,-2.5) node[below]{i};
  \draw [->] (0,-2.6) -- (0,-0.5) node[left] {$p$};
  \draw [color=blue,domain=0:6,thick,smooth] plot[id=exp] function{(2*exp(-(x-3)*(x-3)))*(exp(-(x-2.5)*(x-2.5)*2))-2.5};

  \draw[dashed] (2.5,-2.7) -- (2.5, 5);
  \draw[dashed] (3,-2.7) -- (3, 5);
\end{tikzpicture}
\caption{(a),~$p_c$\quad(b),~$p_t$\quad(c),~p}\label{fig:fig}
\end{figure}

\begin{figure}[!ht]
\centering
\includegraphics[width=0.6\textwidth]{edge3.eps}
\caption{最终确定的格雷码光栅边界}
\label{fig:edge_result}
\end{figure}

\section{重建结果}
本文从多个角度对模型进行了表面重建，得到了不同角度的3D点云数据，重建的结果如图~\label{fig:gray_result}。

\begin{figure}[!ht]
\centering
\subfloat[]{
    \includegraphics[width=0.4\textwidth,height=0.3\textwidth]{gray_project.eps}}
\subfloat[]{
    \includegraphics[width=0.4\textwidth,height=0.3\textwidth]{gray_result3.eps}} \\
\subfloat[]{
    \includegraphics[width=0.4\textwidth,height=0.3\textwidth]{gray_white.eps}}
\subfloat[]{
    \includegraphics[width=0.4\textwidth,height=0.3\textwidth]{gray_result.eps}} \\
\subfloat[]{
    \includegraphics[width=0.4\textwidth,height=0.3\textwidth]{gray_project3.eps}}
\subfloat[]{
    \includegraphics[width=0.4\textwidth,height=0.3\textwidth]{gray_result4.eps}} \\
\subfloat[]{
    \includegraphics[width=0.4\textwidth,height=0.31\textwidth]{gray_project4.eps}}
\subfloat[]{
    \includegraphics[width=0.4\textwidth]{gray_result5.eps}}
  \caption{重建结果，左侧图为场景图，右侧为重建的点云}\label{fig:gray_result}
\end{figure}
\section{本章总结}
本章介绍了基于格雷码光栅的3D重建方法。系统结合格雷码光栅和相移线条，并在格雷码光栅的边缘识别等方法进行了创新，提出了
基于概率的边缘识别方法，取得了理想的重建效果。
\chapter{总结和展望}
本文首先对3D重建的原理和结构光技术进行了研究分析和总结，在综合考虑重建所需时间和重建精度等因素后选择基于格雷码光栅的重建方法和基于De Bruijn序列编码条纹的结构光方法实现了3D重建前者属于时间编码而后者属于空间编码。在实际使用中可综合考虑，灵活选择使用方法。
\section{研究总结}
本文主要的研究内容包括：摄像机-投影仪系统定标、结构光的选择、结构光特征识别等方法，提出了$M$通道、离散趋势变换和格雷码光栅边缘识别等概念和方法，具体总结为如下：

\subsection{摄像机-投影仪系统定标}

  对摄像机-投影仪系统进行定标是实现精确3D重建的前提。本文分析了摄像机的成像模型和畸变原因，推导了坐标系转换关系，并使用棋盘格作为定标板而确立了摄像机定标过程。本文将投影仪视作逆成像系统，并利用摄像机定标参数实现了投影仪的定标。

\subsection{结构光选择和设计}

  本文选择两类结构光实现3D重建：时间编码的格雷码光栅和空间编码的De Bruijn序列编码颜色条纹。在De Bruijn序列编码条纹的颜色选择中，本文选择在色度空间中分布较为离散的5种颜色作为编码颜色以便线条检测和颜色识别。在格雷码光栅中又结合相移条纹的方法实现了高分辨率的3D重建。

\subsection{特征识别}

  在特征识别方面本文作了较多创新。对颜色条纹结构光方法，本文提出了颜色校正方法、颜色线条检测方法和颜色识别等方法。在颜色校正中，本文利用EMD实现了反射率校正，避免了物体表面颜色对颜色线条的影响。在线条检测中，本文提出了$M$通道以融合R、G、B通道，提出了离散趋势变换(DTT)实现了线条的识别。在对应点建立之中，本文使用动态规划方法，并设计了特殊的cost函数，实现了被检测出特征与投射特征之间的对应关系建立。最后，本文将线条的颜色识别放在色度空间之中进行，避免了环境光的干扰。

  在基于格雷码光栅的系统中，本文提出了基于自适应阈值和概率的方法确定格雷码光栅的边缘，实现了很好的重建结果。

\section{展望}
本文利用两种方法，实现了具有适用范围广、鲁棒性高的3D重建系统。在后续的研究中，在以下的方面还可以继续深入探究。

\subsection{3D点云的处理}

  本系统的直接输出是物体表面的3D点云，在后续的研究之中，还可以通过Delaunay三角化的方法将点云转化为表面。更进一步地，
  可以将物体表面的实际纹理覆盖于包面之上，使得重建结果更加鲜明和立体化。

  另一方面，本系统一次3D重建输出的结果是从某一个角度观测到的物体表面，要想得到$360^\circ$的全景点云则需要从不同角度重建
  并拼接。目前可以使用多台设备同时从不同角度对物体进行重建，也可以利用单设备和云台转动物体并多次重建并实现拼接。前者速度快但所需成本较高，后者成本低但需进行多次重建。点云拼接可利用Besl和Mckay\cite{besl1992method}提出的ICP算法实现。

\subsection{实现实时重建}

  本文所使用的空间编码的结构光只需要拍摄一幅图像即可实现3D重建，可考虑使用并行处理的方式加速处理比较耗时的环节，如离散趋势变换、动态规划、点云计算，并最终实现实时的3D 重建。实时的3D重建对移动物体具有很大意义。

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 附件部分
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\backmatter

% 参考文献
% 使用 BibTeX，不使用 BibTeX 时注释掉下面一句。
\bibliography{template}

% 不使用 BibTeX
%\begin{thebibliography}{2}
%
%\bibitem{deng:01a}
%{邓建松,~彭冉冉,~陈长松}.
%\newblock {\em \LaTeXe{}~科技排版指南}.
%\newblock 科学出版社,~书号:~7-03-009239-2/TP.1516, 北京, 2001.
%
%\bibitem{wang:00a}
%王磊.
%\newblock {\em \LaTeXe{}~插图指南}.
%\newblock 2000.
%\end{thebibliography}

% 本章可以删去
\begin{comment}
\Nchapter{简历与科研成果}

\noindent {\heiti 基本情况}
\vspace{1ex}

\noindent 赵东威，男，汉族，1987~年~12~月出生，江苏省连云港人。

\vspace{2ex}
\noindent {\heiti 教育背景}

\begin{description}[labelindent=0em, leftmargin=8em, style=sameline]

\item[2010.9～2013.6] 南京大学电子学院嵌入式软件研发实验室 \hfill 硕士

\item[2006.9～2010.6] 南京大学电子学院 \hfill 本科

\end{description}

% 发表文章目录
\vspace{5ex}
\begin{Publications}{2}

\item Zhou, Yu; Zhao, Dongwei; Yu, Yao; Yuan, Jie; Du, Sidan. 2012. ``Adaptive Color Calibration Based One-Shot Structured Light System.'' Sensors 12, no. 8: 10947-10963.

\item Dongwei Zhao; Yu Zhou; Yao Yu; Sidan Du; ``A Novel Peak Detection Method of Structured Light Stripes for 3D Reconstruction'' Intelligent Human-Machine Systems and Cybernetics (IHMSC), 2011 International Conference on , vol.2, no., pp.43-46, 26-27 Aug. 2011 doi: 10.1109/IHMSC.2011.81

\end{Publications}

\vspace{4ex}
\noindent {\heiti 攻读硕士学位期间参与的科研课题}

\begin{enumerate}[label=\arabic*., labelindent=0em, leftmargin=*]

\item ``基于结构光的3D重建''
（课题年限~2010.9～2011.9），负责算法设计和实现。

\item ``智能教学机器人''
（课题年限~2009.11～2010.7），负责软件开发和实现。

\end{enumerate}
\end{comment}

  % 致谢
\begin{thanks}
\vskip 18pt

本文的研究内容是在我的导师都思丹老师、周余老师、于耀老师的悉心指导和帮助下完成的。在整个研究生学习期间，我的导师
为我提供了卓越、轻松友好的学习研究环境，并在思想、研究等方面给予了很多的关怀和指引，使得我对生活和人生的认识和理解得到极大提升。导师严谨的治学态度和颇具前瞻性的眼光对我产生了深刻影响，是我在今后工作生活中的榜样，谨想导师致以崇高敬意！

周余老师、于耀老师很关心我的学习和科研，每次与周余老师、于耀老师的讨论都其送而富有创意并都能够获益很深。我印象最深的是周余老师
、于耀老师曾带领我去上海参观Intel嵌入式设计大赛，看到了全国各地大学生创作的作品，极大地开阔了眼界和见识。周余老师儒雅富有思想，于耀老师博学刻苦，两位老师对我帮助很大，感谢你们！

感谢王自强老师、彭成磊老师等我的授业恩师！

还要感谢任结、宋宇、王研的相伴，感谢刑天威、陆桂亮、邹润等师弟师妹，正是你们使得实验室冲吗朝气和欢乐！感谢王大千、黄锋、杨瑜、许斌锋等师兄，你们同样对我帮助很大！
\end{thanks}


\end{document}
